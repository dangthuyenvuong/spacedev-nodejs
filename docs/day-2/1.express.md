# Middleware

Middleware là logic nằm giữa, sau hoặc trước 1 logic nào đó

Ví dụ để tạo một log middleware:

```js
const logMiddleware = (req, res, next) => {
    console.log(`[${req.method}]: ${req.url}`, req.body)
    next()
}
```

Trong đó: 

    req: Request chứa toàn bộ thông tin từ client gửi lên

    res: Response dùng để response thông tin về cho client

    next: NextFunction dùng để cho phép express tìm đến function handler kế tiếp

Gắn middleware vào app:

```js

app.use(logMiddleware) // Gắn vào toàn bộ các router

app.use('/task', logMiddleware) // Chỉ gắn vào các router có prefix là /task
```

Trong express sử dụng khái niệm handler

1 request của user sẽ tuần tự đi qua 1 array chứa nhiều handler, mỗi handler đóng vai trò 1 chức năng nào đó. ví dụ: express.json() để parse data vào body, logMiddleware để log thông tin request ra terminal, cuối cùng sẽ đến handler chính để xử lý logic chính của api đó. Khi có 1 handler nào không thực thi NextFunction, request đó sẽ được dừng tại thời điểm đó

Lưu ý: Trong 1 request, response chỉ được trả về cho client đúng 1 lần nếu không sẽ bị thông báo lỗi

Thứ tự khai báo middleware rất quan trọng

Có một middleware đặc biệt gọi là error handler ví dụ:


```js
const errorMiddleware = (error, req, res, next) => {
    console.error('error', error)
    if (error) {
        if (error instanceof Error) {
            return res.status(500).json({ error: error.message })
        }
        return res.status(500).send(error)
    }
    next()
}
```

Khi sử dụng, chúng ta cần sử dụng error handler ở cuối cùng của khai báo router

```js
app.use('/task', taskRouter)
app.use('/category', categoryRouter)
app.use('/member', memberRouter)

// error handler
app.use(errorMiddleware)
```

Khi 1 request bị lỗi, hoặc trong router handler throw ra một lỗi bất kỳ thì error handler sẽ được thực thi. Có thể khai báo nhiều error handler tùy mục đích


Khi muốn error handler xử lý, chúng ta cần gọi hàm next và truyền error param hoặc throw một Error object. Tự động error handler sẽ được thực thi

```js
taskRouter.delete('/:id', (req, res, next) => {
    const { id } = req.params
    const check = Task.deleteById(id)
    if (check) {
        res.sendStatus(204)
    } else {
        // 2 dòng này đều giống nhau chỉ chọn 1 trong 2, error handler sẽ nhận đc tham số error là 1 object kiểu Error
        // next(new Error('Task không tồn tại'))
        throw new Error('Task không tồn tại')
    }
})
```

# TO DO LIST

[] Log middleware

[] Handler error

[] morgan
